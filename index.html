<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReQuiz | Home</title>
    <link rel="icon" href="resources/requiz-icon.png">
    <link rel="stylesheet" href="resources/base-styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;500;900&display=swap">

    <script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-database.js"></script>

    <style>

      .quizfinder-welcome, .quizfinder-quiz {
        padding: 20px;
        margin-top: 20px;
        border-radius: 10px;
        box-shadow: 0px 0px 10px 0px rgba(200, 200, 200, 0.5);
        user-select: none;
      }

      .quizfinder-quiz {
        transition: background-color 0.25s;
      }
      .quizfinder-quiz:hover {
        cursor: pointer;
      }
      .quizfinder-quiz:active {
        background-color: rgb(250, 250, 250);
      }

      .quizfinder-title {
        display: flex;
      }
      .quizfinder-title h1 {
        flex-grow: 1;
      }
      .quizfinder-title a {
        margin: 0px 5px 0px 0px;
        font-weight: 300;
        line-height: 24pt;
      }

    </style>
  </head>
  <body>

    <div class="header">
      <div class="header-title">
        <div class="header-logo-container"><a href="https://quiz.simplexshotz.tk/index.html"><img class="header-logo" src="resources/requiz-icon.png"></a></div>
        <div class="header-text-container"><h1 class="header-text"><a href="https://quiz.simplexshotz.tk/index.html">ReQuiz</a></h1></div>
      </div>
      <div class="header-links">
        <div class="dropdown-container">
          <div class="dropdown"><div class="dropdown-text">Quizzes</div><div class="down-arrow"></div></div>
          <div class="spacer"></div>
          <div class="dropdown-list">
            <div class="dropdown-item" id="dropdown-item-new-quiz">Quiz Editor</div>
            <div class="spacer"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="content">
      <div class="quizfinder-welcome">
        <h1>Welcome to ReQuiz!</h1>
        <p>Check out a list of all the quizzes on this site by selecting the "Quizzes" dropdown in the header, or view the most recent quizzes below!</p>
        <p class="no-margin-bottom">You can always return to this page by clicking on the ReQuiz logo.</p>
      </div>
      <div class="quizfinder-quizzes">

      </div>
    </div>

    <script>

      // Firebase Configuration:
      var firebaseConfig = {
        apiKey: "AIzaSyBrg6aS2Guc3b4pnmt7hYVdJ7pQY-DS61E",
        authDomain: "ss-requiz.firebaseapp.com",
        databaseURL: "https://ss-requiz.firebaseio.com",
        projectId: "ss-requiz",
        storageBucket: "ss-requiz.appspot.com",
        messagingSenderId: "1058999305226",
        appId: "1:1058999305226:web:7fd71e16621777c75b4bf3"
      };

      firebase.initializeApp(firebaseConfig);

      let database = firebase.database();

      let ref = {
        quizzes: database.ref("quizzes")
      };

      window.addEventListener("load", function() {
        ref.quizzes.once("value", function(data) {
          let d = data.val();

          let quizzes = []; // Convert from object to array
          for (let i in d) {
            d[i].i = i;
            quizzes.push(d[i]);
          }

          quicksort(quizzes, 0, quizzes.length - 1, "created"); // Sort by date/time created

          for (let i = 0; i < quizzes.length; i++) {
            let dropdownEl = document.createElement("div");
            dropdownEl.innerHTML = `
              <div class="dropdown-item" class="dropdown-item" onclick="openQuiz('${quizzes[i].i}')">${quizzes[i].name}</div>
            `;
            document.getElementsByClassName("dropdown-list")[0].appendChild(dropdownEl);

            let questionLength = (quizzes[i].options.questionsToShow ? quizzes[i].options.questionsToShow : quizzes[i].questions.length);

            let quizEl = document.createElement("div");
            quizEl.innerHTML = `
              <div class="quizfinder-quiz" onclick="openQuiz('${quizzes[i].i}')">
                <div class="quizfinder-title">
                  <h1 class="quizfinder-name">${quizzes[i].name}</h1>
                  ${quizzes[i].options.editable ? `<a class="small" href="https://quiz.simplexshotz.tk/quiz-creator/index.html?quiz=${quizzes[i].i}">Edit</a>` : ``}
                </div>
                <p class="quizfinder-questions no-margin">${questionLength} Question${questionLength !== 1 ? "s" : ""}</p>
                <p class="quizfinder-time small">${quizzes[i].edited ? "Edited" : "Created"} ${convertToTimeString(new Date().getTime() - quizzes[i].created)} ago</p>
              </div>
            `;
            document.getElementsByClassName("quizfinder-quizzes")[0].appendChild(quizEl);
          }
        });
      });

      function openQuiz(i) {
        window.open("https://quiz.simplexshotz.tk/quiz/index.html?quiz=" + i, "_self");
      }

      function convertToTimeString(time) {

        let value = 0;
        let unit = "";

        if (time < 60 * 1000) { // Less than 1 min ago
          value = Math.floor(time / 1000);
          unit = "second";
        } else if (time < 60 * 60 * 1000) { // Less than 1 hour ago
          value = Math.floor(time / (60 * 1000));
          unit = "minute";
        } else if (time < 24 * 60 * 60 * 1000) { // Less than 1 day ago
          value = Math.floor(time / (60 * 60 * 1000));
          unit = "hour";
        } else if (time < 365 * 24 * 60 * 60 * 1000) { // Less than 1 year ago
          value = Math.floor(time / (24 * 60 * 60 * 1000));
          unit = "day";
        } else { // More than 1 year ago
          value = Math.floor(time / (365 * 24 * 60 * 60 * 1000));
          unit = "year";
        }

        return value + " " + unit + (value !== 1 ? "s" : "");

      }

      document.getElementsByClassName("dropdown")[0].addEventListener("click", function() {
        toggle("down-arrow");
        toggle("dropdown-list");
        toggle("dropdown-container");
      });

      document.getElementById("dropdown-item-new-quiz").addEventListener("click", function() {
        window.open("https://quiz.simplexshotz.tk/quiz-creator/index.html", "_self");
      });

      function toggle(cl) {
        let el = document.getElementsByClassName(cl)[0];

        let clA = cl + "-active";
        if (el.classList.contains(clA)) {
          el.classList.remove(clA);
        } else {
          el.classList.add(clA);
        }

      }

      function partition(arr, lo, hi, by) {
        var pivot = (by ? arr[hi][by] : arr[hi]);
        var i = lo;
        for (var j = lo; j < hi; j++) {
          if ((by ? arr[j][by] : arr[j]) > pivot) {
            if (i !== j) {
              var t = arr[j];
              arr[j] = arr[i];
              arr[i] = t;
            }
            i++;
          }
        }
        var t = arr[hi];
        arr[hi] = arr[i];
        arr[i] = t;
        return i;
      }
      function quicksort(arr, lo, hi, by) {
        if (lo < hi) {
          var p = partition(arr, lo, hi, by);
          quicksort(arr, lo, p - 1, by);
          quicksort(arr, p + 1, hi, by);
        }
      }

    </script>
  </body>
</html>
