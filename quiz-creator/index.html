<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReQuiz | Quiz Editor</title>
    <link rel="icon" href="../resources/requiz-icon.png">
    <link rel="stylesheet" href="../resources/base-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;500;900&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-database.js"></script>

    <style>

      .quizcreator-option {
        display: flex;
      }
      .quizcreator-option-input-container {
        flex-direction: column;
      }
      .quizcreator-option-label {
        display: inline-block;
        margin: 5px 0px;
      }
      .quizcreator-checkbox-container {
        display: flex;
        margin-right: 10px;
        flex-direction: column;
        justify-content: center;
      }

      .quizcreator-title, .quizcreator-options, .question, .new-question, .create-quiz {
        padding: 20px;
        margin-top: 20px;
        border-radius: 10px;
        box-shadow: 0px 0px 10px 0px rgba(200, 200, 200, 0.5);
        user-select: none;
        flex-direction: column;
      }
      .quizcreator-name, .question-question, .quizcreator-option-input {
        width: calc(100% - 12px);
        padding: 5px;
        font-size: 14pt;
      }
      .quizcreator-name:focus, .question-question:focus, .quizcreator-option-input:focus {
        outline: none;
      }
      .question-title {
        display: flex;
      }
      .question-title h1 {
        flex-grow: 1;
        margin: 0px;
      }
      .question-title p {
        margin: 0px 5px 0px 0px;
        font-weight: 300;
        line-height: 24pt;
      }
      .question-title p:hover {
        cursor: pointer;
      }
      .question-image-display {
        max-width: 50%;
        max-height: 100px;
      }
      .question-answers-container {
        display: flex;
      }
      .question-answers {
        flex-grow: 1;
      }
      .question-answer {
        margin-bottom: 5px;
      }
      .question-answer-input {
        width: calc(80% - 12px);
        padding: 5px;
        font-size: 14pt;
      }
      .question-answer-input:focus {
        outline: none;
      }
      .question-answer-correct {
        margin-right: 10px;
      }
      .question-answers-note {
        display: flex;
        width: 40%;
        justify-content: center;
        flex-direction: column;
      }
      .note {
        font-size: 12pt;
        margin: 0px;
      }

      .new-question, .create-quiz {
        transition: background-color 0.25s;
      }
      .new-question:hover, .create-quiz:hover {
        cursor: pointer;
      }
      .new-question:active, .create-quiz:active {
        background-color: rgb(250, 250, 250);
      }

    </style>
  </head>
  <body>

    <div class="header">
      <div class="header-title">
        <div class="header-logo-container"><a href="https://quiz.simplexshotz.tk/index.html"><img class="header-logo" src="../resources/requiz-icon.png"></a></div>
        <div class="header-text-container"><h1 class="header-text"><a href="https://quiz.simplexshotz.tk/index.html">ReQuiz</a></h1></div>
      </div>
      <div class="header-links">
        <div class="dropdown-container">
          <div class="dropdown"><div class="dropdown-text">Quizzes</div><div class="down-arrow"></div></div>
          <div class="spacer"></div>
          <div class="dropdown-list">
            <div class="dropdown-item" id="dropdown-item-new-quiz">Quiz Editor</div>
            <div class="spacer"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="content">
      <div class="quizcreator">
        <div class="quizcreator-title">
          <h1>Quiz Editor</h1>
          <input class="quizcreator-name" type="text" placeholder="Quiz Name" onkeyup="updateName(this)">
        </div>
        <div class="quizcreator-options">
          <h1>Options</h1>
          <div class="quizcreator-option quizcreator-option-checkbox-container">
            <div class="quizcreator-checkbox-container">
              <input class="quizcreator-option-checkbox" type="checkbox" title="Allows this quiz to be edited. If this is NOT selected, this quiz will not be able to be edited by anyone, including yourself." onclick="updateOption('editable', this)">
            </div>
            <p class="quizcreator-option-label">Editable by Anyone</p>
          </div>
          <div class="quizcreator-option quizcreator-option-checkbox-container">
            <div class="quizcreator-checkbox-container">
              <input class="quizcreator-option-checkbox" type="checkbox" title="Randomizes the order in which questions are presented." onclick="updateOption('randomizeQuestionOrder', this)">
            </div>
            <p class="quizcreator-option-label">Randomize Question Order</p>
          </div>
          <div class="quizcreator-option quizcreator-option-input-container">
            <p class="quizcreator-option-label">Questions to Show (leave as "0" to show all):</p>
            <input class="quizcreator-option-input" type="number" title='This is how many questions will be shown each time the quiz is taken. For example, if your quiz has 10 questions, but this value is set to 5, only 5 out of the 10 quesitons will be shown each time someone takes your quiz. If you change this value, you should enable "Randomize Question Order," as otherwise, some questions may never be seen.' onchange="updateOption('questionsToShow', this)" value="0">
          </div>
          <br>
          <p class="note desktop-only">Note: You can hover over checkboxes to get a more in-depth explanation for the option.</p>
        </div>
        <div class="questions">
        </div>
        <div class="new-question">
          <h1 class="no-margin">+ New Question</h1>
        </div>
        <div class="create-quiz" onclick="createQuiz()">
          <h1 class="create-quiz-text no-margin">✓ Create Quiz</h1>
        </div>
      </div>
    </div>

    <div class="errors"></div>

    <script>

      // Firebase Configuration:
      var firebaseConfig = {
        apiKey: "AIzaSyBrg6aS2Guc3b4pnmt7hYVdJ7pQY-DS61E",
        authDomain: "ss-requiz.firebaseapp.com",
        databaseURL: "https://ss-requiz.firebaseio.com",
        projectId: "ss-requiz",
        storageBucket: "ss-requiz.appspot.com",
        messagingSenderId: "1058999305226",
        appId: "1:1058999305226:web:7fd71e16621777c75b4bf3"
      };

      firebase.initializeApp(firebaseConfig);

      let database = firebase.database();

      let ref = {
        quizzes: database.ref("quizzes")
      };

      var quiz = {
        name: "",
        options: {
          editable: false,
          randomizeQuestionOrder: false,
          questionsToShow: 0
        },
        questions: [],
        created: 0,
        edited: false
      };

      window.addEventListener("load", function() {
        ref.quizzes.once("value", function(data) {
          let d = data.val();

          for (let i in d) {
            let el = document.createElement("div");
            el.innerHTML = `<div class="dropdown-item" class="dropdown-item" onclick="openQuiz('${i}')">${d[i].name}</div>`;
            document.getElementsByClassName("dropdown-list")[0].appendChild(el);
          }

          // If editing a quiz:
          let queries = getQueries();
          if (queries.quiz) {
            if (d[queries.quiz].options.editable) {
              document.getElementsByClassName("quizcreator-name")[0].value = d[queries.quiz].name;
              document.getElementsByClassName("quizcreator-option-checkbox")[0].checked = d[queries.quiz].options.editable;
              document.getElementsByClassName("quizcreator-option-checkbox")[1].checked = d[queries.quiz].options.randomizeQuestionOrder;
              document.getElementsByClassName("quizcreator-option-input")[0].value = d[queries.quiz].options.questionsToShow;

              quiz = d[queries.quiz];
              updateQuiz();

              document.getElementsByClassName("create-quiz-text")[0].innerText = "✓ Update Quiz";
            } else {
              error("This quiz is not allowed to be edited.", function() {
                window.open("https://quiz.simplexshotz.tk/index.html", "_self");
              });
            }
          }
        });
      });

      function getQueries() {

        let url = window.location.href;
        let queries = url.split("?");

        queries.splice(0, 1);
        queries = queries.join("?");
        queries = queries.split("&");

        let finalQueries = {};
        for (let i = 0; i < queries.length; i++) {
          finalQueries[queries[i].split("=")[0]] = decodeURI(queries[i].split("=")[1]);
        }

        return finalQueries;
      }

      function openQuiz(i) {
        window.open("https://quiz.simplexshotz.tk/quiz/index.html?quiz=" + i, "_self");
      }

      document.getElementsByClassName("dropdown")[0].addEventListener("click", function() {
        toggle("down-arrow");
        toggle("dropdown-list");
        toggle("dropdown-container");
      });

      document.getElementsByClassName("new-question")[0].addEventListener("click", function() {
        quiz.questions.push({
          question: "",
          imageURI: "",
          answers: [""],
          correctAnswers: []
        });
        let newEl = document.createElement("div");
        newEl.innerHTML = `
          <div class="question">
            <div class="question-title">
              <h1>Question ${quiz.questions.length}</h1>
              <p class="small" onclick="deleteQuestion(${quiz.questions.length - 1})">Delete</p>
            </div>
            <h2>Question:</h2>
            <textarea class="question-question" placeholder="Question" onkeyup="updateQuestion(${quiz.questions.length - 1}, this);"></textarea>
            <h2>Image (Optional):</h2>
            <div class="question-image-container">
              <input class="question-image" type="file" onchange="updateImage(${quiz.questions.length - 1}, this)">
              <div class="question-image-display-container" style="display: none;">
                <br><img class="question-image-display" src="">
              </div>
            </div>
            <h2>Answers:</h2>
            <div class="question-answers-container">
              <div class="question-answers">
                <div class="question-answer">
                  <input class="question-answer-correct" type="checkbox" title="This is a correct answer." onclick="updateCorrect(${quiz.questions.length - 1}, 0, this)">
                  <input class="question-answer-input" type="text" placeholder="Answer 1" onkeyup="updateAnswer(${quiz.questions.length - 1}, 0, this)">
                </div>
              </div>
              <div class="question-answers-note">
                ${quiz.questions.length === 1 ? "<p class='note'>Note: Empty fields will be deleted when the quiz is created.</p>" : ""}
              </div>
            </div>
          </div>
        `;
        document.getElementsByClassName("questions")[0].appendChild(newEl);
      });

      function createQuiz() {
        ref.quizzes.once("value", function(data) {
          let d = data.val();

          // Quiz verification:
          let verified = true;
          if (quiz.name !== "") { // Verify that it has a name
            let nameExists = false;
            for (let i in d) {
              if (d[i].name === quiz.name) {
                nameExists = true;
                break;
              }
            }

            if (!nameExists || getQueries().quiz) { // Verify that the name does not already exist
              if (quiz.questions.length !== 0) { // Verify that the quiz has at least 1 question
                for (let i = 0; i < quiz.questions.length; i++) {
                  if (quiz.questions[i].question === "") { // Verify that all questions have a question
                    error("Question " + (i + 1) + "'s question field is blank.");
                    verified = false;
                  } else {
                    let allBlankAnswers = true;
                    for (let j = 0; j < quiz.questions[i].answers.length; j++) {
                      if (quiz.questions[i].answers[j] !== "") {
                        allBlankAnswers = false;
                        break;
                      }
                    }
                    if (!allBlankAnswers) { // Verify that there is at least one actual answer
                      if (quiz.questions[i].correctAnswers.length === 0) { // There are no correct answers
                        error("You must select at least 1 correct answer for Question " + (i + 1) + "!");
                        verified = false;
                      } else {
                        let allCorrectAnswersBlank = true;
                        for (let k = 0; k < quiz.questions[i].correctAnswers.length; k++) {
                          if (quiz.questions[i].answers[quiz.questions[i].correctAnswers[k]] !== "") {
                            allCorrectAnswersBlank = false;
                          }
                        }
                        if (allCorrectAnswersBlank) { // All correct answers are blank
                          error("You must select at least 1 correct answer for Question " + (i + 1) + " that isn't blank!");
                          verified = false;
                        }
                      }
                    } else { // All answers are blank
                      error("All of Question " + (i + 1) + "'s answer fields are blank.");
                      verified = false;
                    }
                  }
                }
              } else { // Quiz has no questions
                error("You can't create a quiz with no questions! Add some questions and try again.");
                verified = false;
              }
            } else { // Name already exists
              error("A quiz with that name already exists! Use a more unique name and try again.");
              verified = false;
            }
          } else { // Does not have a name
            error("Enter a name for the quiz!");
            verified = false;
          }
          if (verified) {
            // Remove all empty answers:
            for (let i = 0; i < quiz.questions.length; i++) {
              for (let j = 0; j < quiz.questions[i].answers.length; j++) {
                if (quiz.questions[i].answers[j] === "") {
                  quiz.questions[i].answers.splice(j, 1);
                  if (quiz.questions[i].correctAnswers.indexOf(j) !== -1) {
                    quiz.questions[i].correctAnswers.splice(quiz.questions[i].correctAnswers.indexOf(j), 1);
                  }
                  // Decrement indices higher than "j":
                  for (let k = 0; k < quiz.questions[i].correctAnswers.length; k++) {
                    if (quiz.questions[i].correctAnswers[k] > j) {
                      quiz.questions[i].correctAnswers[k]--;
                    }
                  }
                }
              }
            }

            if (quiz.options.questionsToShow > quiz.questions.length) {
              quiz.options.questionsToShow = quiz.questions.length;
            }

            quiz.created = new Date().getTime();

            let queries = getQueries();
            if (queries.quiz) {
              quiz.edited = true;
            }

            ref.quizzes.child(queries.quiz ? queries.quiz : quiz.name).set(quiz);

            // Load the quiz when it has been created:
            ref.quizzes.on("value", function(data) {
              let d = data.val();

              let queries = getQueries();
              if (queries.quiz && d[queries.quiz] || d[quiz.name]) {
                window.open("https://quiz.simplexshotz.tk/quiz/index.html?quiz=" + (queries.quiz ? queries.quiz : quiz.name), "_self");
              }
            })
          } else {
            let queries = getQueries();
            document.getElementsByClassName("create-quiz-text")[0].innerText = queries.quiz ? "✓ Update Quiz" : "✓ Create Quiz";
          }
        });
        let queries = getQueries();
        document.getElementsByClassName("create-quiz-text")[0].innerText = queries.quiz ? "Updating Quiz..." : "Creating Quiz...";
      }


      document.getElementById("dropdown-item-new-quiz").addEventListener("click", function() {
        window.open("https://quiz.simplexshotz.tk/quiz-creator/index.html", "_self");
      });

      function toggle(cl, oel) {
        let el = oel || document.getElementsByClassName(cl)[0];

        let clA = cl + "-active";
        if (el.classList.contains(clA)) {
          el.classList.remove(clA);
        } else {
          el.classList.add(clA);
        }

      }

      function deleteQuestion(Qi) {
        if (confirm("Are you sure you want to delete this question? You cannot undo this action.")) {
          quiz.questions.splice(Qi, 1);

          updateQuiz();
        }
      }

      function updateImage(Qi, el) {

        var reader = new FileReader();

        reader.onloadend = function() {
          el.parentNode.childNodes[3].style.display = "block";
          el.parentNode.childNodes[3].childNodes[2].src = reader.result;

          quiz.questions[Qi].imageURI = reader.result;
        };

        if (el.files[0]) {
          reader.readAsDataURL(el.files[0]);
        } else {
          el.parentNode.childNodes[3].style.display = "none";
          el.parentNode.childNodes[3].childNodes[2].src = "";

          quiz.questions[Qi].imageURI = "";
        }

      }

      function updateName(el) {
        quiz.name = el.value;
      }
      function updateOption(option, el) {
        switch(option) {
          case "editable":
            quiz.options.editable = el.checked;
          break;
          case "randomizeQuestionOrder":
            quiz.options.randomizeQuestionOrder = el.checked;
          break;
          case "questionsToShow":
            quiz.options.questionsToShow = Number(el.value) || 0;
            el.value = quiz.options.questionsToShow;
          break;
        }
      }
      function updateQuestion(i, el) {
        quiz.questions[i].question = el.value;
      }
      function updateCorrect(Qi, Ai, el) {
        if (quiz.questions[Qi].correctAnswers.indexOf(Ai) === -1 && el.checked) {
          quiz.questions[Qi].correctAnswers.push(Ai);
        } else if (quiz.questions[Qi].correctAnswers.indexOf(Ai) !== -1 && !el.checked) {
          quiz.questions[Qi].correctAnswers.splice(quiz.questions[Qi].correctAnswers.indexOf(Ai), 1);
        }
      }
      function updateAnswer(Qi, Ai, el) { // question index / answer index
        quiz.questions[Qi].answers[Ai] = el.value;
        if (el.value !== "" && Ai === quiz.questions[Qi].answers.length - 1) {
          quiz.questions[Qi].answers.push("");
          let newEl = document.createElement("div");
          newEl.innerHTML = `
            <div class="question-answer">
              <input class="question-answer-correct" type="checkbox" title="This is a correct answer." onclick="updateCorrect(${Qi}, ${quiz.questions[Qi].answers.length - 1}, this)">
              <input class="question-answer-input" type="text" placeholder="Answer ${quiz.questions[Qi].answers.length}" onkeyup="updateAnswer(${Qi}, ${quiz.questions[Qi].answers.length - 1}, this)">
            </div>
          `;
          el.parentNode.parentNode.appendChild(newEl);
        }
      }

      function updateQuiz() {
        document.getElementsByClassName("questions")[0].innerHTML = "";

        for (let i = 0; i < quiz.questions.length; i++) {
          let newEl = document.createElement("div");
          let answerText = "";
          for (let j = 0; j < quiz.questions[i].answers.length + 1; j++) {
            if (j === quiz.questions[i].answers.length && quiz.questions[i].answers[quiz.questions[i].answers.length - 1] !== "" || j !== quiz.questions[i].answers.length) {
              answerText += `
                <div class="question-answer">
                  <input class="question-answer-correct" type="checkbox" title="This is a correct answer." ${(j < quiz.questions[i].answers.length && quiz.questions[i].correctAnswers.indexOf(j) !== -1) ? "checked" : ""} onclick="updateCorrect(${i}, ${j}, this)">
                  <input class="question-answer-input" type="text" placeholder="Answer ${j + 1}" value="${j < quiz.questions[i].answers.length ? quiz.questions[i].answers[j] : ""}" onkeyup="updateAnswer(${i}, ${j}, this)">
                </div>
              `;
            }
          }
          if (quiz.questions[i].answers[quiz.questions[i].answers.length - 1] !== "") {
            quiz.questions[i].answers.push("");
          }
          newEl.innerHTML = `
            <div class="question">
              <div class="question-title">
                <h1>Question ${i + 1}</h1>
                <p class="small" onclick="deleteQuestion(${i})">Delete</p>
              </div>
              <h2>Question:</h2>
              <input class="question-question" type="text" placeholder="Question" value="${quiz.questions[i].question}" onkeyup="updateQuestion(${i}, this);">
              <h2>Image (Optional):</h2>
              <div class="question-image-container">
                <input class="question-image" type="file" onchange="updateImage(${i}, this)">
                <div class="question-image-display-container" style="display: ${quiz.questions[i].imageURI ? "block" : "none"};">
                  <br><img class="question-image-display" src="${quiz.questions[i].imageURI ? quiz.questions[i].imageURI : ""}">
                </div>
              </div>
              <h2>Answers:</h2>
              <div class="question-answers-container">
                <div class="question-answers">
                  ${answerText}
                </div>
                <div class="question-answers-note">
                  ${i === 0 ? "<p class='note'>Note: Empty fields will be deleted when the quiz is created.</p>" : ""}
                </div>
              </div>
            </div>
          `;
          document.getElementsByClassName("questions")[0].appendChild(newEl);
        }
        // TODO: update answers
      }

      let errors = [];
      function error(txt, callback) {
        errors.push(txt);
        let el = document.createElement("div");
        el.innerHTML = `<div class="error"><div class="error-icon-container"><img class="error-icon" src="../resources/requiz-alert.png"></div><h1 class="error-text">${txt}</h1></div>`;
        document.getElementsByClassName("errors")[0].appendChild(el);
        setTimeout(function() {
          toggle("error", el.childNodes[0]);
          setTimeout(function() {
            el.parentNode.removeChild(el);
            if (callback) {
              callback();
            }
          }, 500);
        }, 3000);
      }

    </script>
  </body>
</html>
